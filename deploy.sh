#!/bin/bash

# GitHub Pages éƒ¨ç½²è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: ./deploy.sh

set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° GitHub Pages..."

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„åˆ†æ”¯
current_branch=$(git branch --show-current)
if [ "$current_branch" != "main" ]; then
    echo "âŒ é”™è¯¯: è¯·åœ¨ main åˆ†æ”¯ä¸Šè¿è¡Œæ­¤è„šæœ¬"
    echo "å½“å‰åˆ†æ”¯: $current_branch"
    exit 1
fi

# æ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„æ›´æ”¹
if [ -n "$(git status --porcelain)" ]; then
    echo "âŒ é”™è¯¯: æœ‰æœªæäº¤çš„æ›´æ”¹ï¼Œè¯·å…ˆæäº¤æˆ–æš‚å­˜"
    git status --short
    exit 1
fi

# å®‰è£…ä¾èµ–
echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
npm ci

# æ„å»ºé¡¹ç›®
echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
npm run build-only

# æ£€æŸ¥æ„å»ºç»“æœ
if [ ! -d "dist" ]; then
    echo "âŒ é”™è¯¯: æ„å»ºå¤±è´¥ï¼Œdist ç›®å½•ä¸å­˜åœ¨"
    exit 1
fi

# æäº¤å¹¶æ¨é€
echo "ğŸ“ æäº¤æ›´æ”¹..."
git add .
git commit -m "chore: æ›´æ–°æ„å»ºæ–‡ä»¶" || echo "æ²¡æœ‰æ–°çš„æ›´æ”¹éœ€è¦æäº¤"

echo "ğŸ“¤ æ¨é€åˆ° GitHub..."
git push origin main

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸŒ æ‚¨çš„ç½‘ç«™å°†åœ¨å‡ åˆ†é’Ÿåå¯ç”¨: https://$(git config user.name).github.io/AIclassS/"
echo "ğŸ“Š æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€: https://github.com/$(git config user.name)/AIclassS/actions"


